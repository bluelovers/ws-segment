"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const express = require("express");
const cors = require("cors");
const core_1 = require("novel-segment/lib/segment/core");
const useModules2_1 = require("novel-segment/lib/segment/methods/useModules2");
const mod_1 = require("novel-segment/lib/mod");
const url_1 = require("url");
const min_1 = require("cjk-conv/lib/zh/convert/min");
const app = express();
let CACHED_SEGMENT;
app.use(express.json());
app.use(express.urlencoded({ extended: true }));
app.use(cors());
all_method(app, '/conv', app_conv);
all_method(app, '*', app_segment);
exports.default = app;
async function app_segment(req, res, next) {
    let rq = get_query(req);
    res.set({
        //'Access-Control-Allow-Origin': '*',
        'Content-Type': 'application/json',
    });
    const timestamp = Date.now();
    let error;
    if (rq.input && rq.input.length) {
        rq.input = handle_input(rq.input).input;
        if (Array.isArray(rq.input)) {
            rq.options = rq.options || {};
            try {
                const results = rq.input.map(line => {
                    if (typeof line !== 'string') {
                        line = Buffer.from(line).toString();
                    }
                    return doSegment(line, rq.options);
                });
                if (!rq.nocache && !rq.debug) {
                    res.set({
                        'Cache-Control': 'public, max-age=3600000',
                    });
                }
                const json = {
                    code: 1,
                    count: results.length,
                    timestamp,
                    time: Date.now() - timestamp,
                    results,
                    options: rq.options,
                };
                if (rq.debug) {
                    // @ts-ignore
                    json.request = {
                        rq,
                        params: req.params,
                        query: req.query,
                        body: req.body,
                        baseUrl: req.baseUrl,
                        url: req.url,
                        query2: url_1.parse(req.url, true).query,
                    };
                }
                res.status(200).json(json);
                return;
            }
            catch (e) {
                error = e;
                res.status(500).json({
                    code: 0,
                    error: true,
                    timestamp,
                    message: error.message,
                    request: rq,
                });
                return;
            }
        }
    }
    if (!rq.nocache) {
        res.set({
            'Cache-Control': 'public, max-age=10000',
        });
    }
    res.status(400).json({
        code: 0,
        error: true,
        timestamp,
        message: '參數錯誤',
        request: rq,
    });
}
async function app_conv(req, res, next) {
    let rq = get_query(req, {
        options: {},
    });
    const timestamp = Date.now();
    let error;
    try {
        const { input, empty } = handle_input(rq.input);
        delete rq.input;
        const { tw2cn } = rq.options;
        const results = input_map(input, (input) => {
            let text = doSegment(input, {
                simple: true,
            }).join('');
            return tw2cn ? min_1.tw2cn_min(text) : min_1.cn2tw_min(text);
        });
        if (!rq.nocache && !rq.debug) {
            res.set({
                'Cache-Control': 'public, max-age=3600000',
            });
        }
        const json = {
            code: 1,
            count: results.length,
            timestamp,
            time: Date.now() - timestamp,
            results,
        };
        res.status(200).json(json);
        return;
    }
    catch (e) {
        if (!rq.nocache) {
            res.set({
                'Cache-Control': 'public, max-age=10000',
            });
        }
        res.status(500).json({
            code: 0,
            error: true,
            timestamp,
            message: e.message,
            request: rq,
        });
    }
}
function handle_input(input) {
    if (typeof input === 'string') {
        input = [input];
    }
    let empty = (input.length === 0 || input.length === 1 && input[0].length === 0);
    return {
        input,
        empty,
    };
}
function input_map(input, fn) {
    return input.map(input => {
        if (typeof input !== 'string') {
            input = Buffer.from(input).toString();
        }
        return fn(input);
    });
}
function createSegment() {
    return new core_1.default({
        autoCjk: true,
        optionsDoSegment: {
            convertSynonym: true,
        },
        all_mod: true,
    });
}
function getSegment() {
    if (CACHED_SEGMENT) {
        return CACHED_SEGMENT;
    }
    const DICT = require('./cache.json');
    CACHED_SEGMENT = createSegment();
    useModules2_1.useModules(CACHED_SEGMENT, mod_1.default(CACHED_SEGMENT.options.all_mod));
    CACHED_SEGMENT.DICT = DICT;
    CACHED_SEGMENT.inited = true;
    return CACHED_SEGMENT;
}
function doSegment(text, options) {
    return getSegment().doSegment(text, options);
}
function all_method(app, routerPath, ...cb) {
    app.get(routerPath, ...cb);
    app.post(routerPath, ...cb);
    return app;
}
function get_query(req, init = {}) {
    return Object.assign(init, url_1.parse(req.url, true).query, req.body);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLG1DQUFvQztBQUNwQyw2QkFBOEI7QUFTOUIseURBQTRFO0FBQzVFLCtFQUEyRTtBQUMzRSwrQ0FBc0Q7QUFDdEQsNkJBQXlDO0FBRXpDLHFEQUFtRTtBQUVuRSxNQUFNLEdBQUcsR0FBRyxPQUFPLEVBQUUsQ0FBQztBQUN0QixJQUFJLGNBQXVCLENBQUM7QUFFNUIsR0FBRyxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQztBQUN4QixHQUFHLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxVQUFVLENBQUMsRUFBRSxRQUFRLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQyxDQUFDO0FBQ2hELEdBQUcsQ0FBQyxHQUFHLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQztBQUVoQixVQUFVLENBQUMsR0FBRyxFQUFFLE9BQU8sRUFBRSxRQUFRLENBQUMsQ0FBQztBQUNuQyxVQUFVLENBQUMsR0FBRyxFQUFFLEdBQUcsRUFBRSxXQUFXLENBQUMsQ0FBQztBQUVsQyxrQkFBZSxHQUFHLENBQUE7QUFFbEIsS0FBSyxVQUFVLFdBQVcsQ0FBQyxHQUFZLEVBQUUsR0FBYSxFQUFFLElBQWtCO0lBRXpFLElBQUksRUFBRSxHQUFHLFNBQVMsQ0FLZixHQUFHLENBQUMsQ0FBQztJQUVSLEdBQUcsQ0FBQyxHQUFHLENBQUM7UUFDUCxxQ0FBcUM7UUFDckMsY0FBYyxFQUFFLGtCQUFrQjtLQUNsQyxDQUFDLENBQUM7SUFFSCxNQUFNLFNBQVMsR0FBRyxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUM7SUFFN0IsSUFBSSxLQUFZLENBQUM7SUFFakIsSUFBSSxFQUFFLENBQUMsS0FBSyxJQUFJLEVBQUUsQ0FBQyxLQUFLLENBQUMsTUFBTSxFQUMvQjtRQUNDLEVBQUUsQ0FBQyxLQUFLLEdBQUcsWUFBWSxDQUFDLEVBQUUsQ0FB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cG9ydCBjb3JzID0gcmVxdWlyZSgnY29ycycpO1xuaW1wb3J0IHtcblx0ZGVmYXVsdCBhcyBjb3JlLFxuXHROZXh0RnVuY3Rpb24sXG5cdFJlcXVlc3QsXG5cdFJlc3BvbnNlLFxuXHRFeHByZXNzLFxuXHRSZXF1ZXN0SGFuZGxlclBhcmFtcyxcbn0gZnJvbSAnZXhwcmVzcy1zZXJ2ZS1zdGF0aWMtY29yZSc7XG5pbXBvcnQgU2VnbWVudCwgeyBJT3B0aW9uc0RvU2VnbWVudCB9IGZyb20gJ25vdmVsLXNlZ21lbnQvbGliL3NlZ21lbnQvY29yZSc7XG5pbXBvcnQgeyB1c2VNb2R1bGVzIH0gZnJvbSAnbm92ZWwtc2VnbWVudC9saWIvc2VnbWVudC9tZXRob2RzL3VzZU1vZHVsZXMyJztcbmltcG9ydCBnZXREZWZhdWx0TW9kTGlzdCBmcm9tICdub3ZlbC1zZWdtZW50L2xpYi9tb2QnO1xuaW1wb3J0IHsgcGFyc2UgYXMgdXJsX3BhcnNlIH0gZnJvbSAndXJsJztcbmltcG9ydCB7IGNybGYgfSBmcm9tICdjcmxmLW5vcm1hbGl6ZSc7XG5pbXBvcnQgeyBjbjJ0d19taW4sIHR3MmNuX21pbiB9IGZyb20gJ2Nqay1jb252L2xpYi96aC9jb252ZXJ0L21pbic7XG5cbmNvbnN0IGFwcCA9IGV4cHJlc3MoKTtcbmxldCBDQUNIRURfU0VHTUVOVDogU2VnbWVudDtcblxuYXBwLnVzZShleHByZXNzLmpzb24oKSk7XG5hcHAudXNlKGV4cHJlc3MudXJsZW5jb2RlZCh7IGV4dGVuZGVkOiB0cnVlIH0pKTtcbmFwcC51c2UoY29ycygpKTtcblxuYWxsX21ldGhvZChhcHAsICcvY29udicsIGFwcF9jb252KTtcbmFsbF9tZXRob2QoYXBwLCAnKicsIGFwcF9zZWdtZW50KTtcblxuZXhwb3J0IGRlZmF1bHQgYXBwXG5cbmFzeW5jIGZ1bmN0aW9uIGFwcF9zZWdtZW50KHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSwgbmV4dDogTmV4dEZ1bmN0aW9uKVxue1xuXHRsZXQgcnEgPSBnZXRfcXVlcnk8e1xuXHRcdGlucHV0OiBzdHJpbmcgfCAoc3RyaW5nIHwgQnVmZmVyKVtdLFxuXHRcdG9wdGlvbnM6IElPcHRpb25zRG9TZWdtZW50LFxuXHRcdG5vY2FjaGU6IGJvb2xlYW4sXG5cdFx0ZGVidWc6IGJvb2xlYW4sXG5cdH0+KHJlcSk7XG5cblx0cmVzLnNldCh7XG5cdFx0Ly8nQWNjZXNzLUNvbnRyb2wtQWxsb3ctT3JpZ2luJzogJyonLFxuXHRcdCdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbicsXG5cdH0pO1xuXG5cdGNvbnN0IHRpbWVzdGFtcCA9IERhdGUubm93KCk7XG5cblx0bGV0IGVycm9yOiBFcnJvcjtcblxuXHRpZiAocnEuaW5wdXQgJiYgcnEuaW5wdXQubGVuZ3RoKVxuXHR7XG5cdFx0cnEuaW5wdXQgPSBoYW5kbGVfaW5wdXQocnEuaW5wdXQpLmlucHV0O1xuXG5cdFx0aWYgKEFycmF5LmlzQXJyYXkocnEuaW5wdXQpKVxuXHRcdHtcblx0XHRcdHJxLm9wdGlvbnMgPSBycS5vcHRpb25zIHx8IHt9O1xuXG5cdFx0XHR0cnlcblx0XHRcdHtcblx0XHRcdFx0Y29uc3QgcmVzdWx0cyA9IHJxLmlucHV0Lm1hcChsaW5lID0+XG5cdFx0XHRcdHtcblxuXHRcdFx0XHRcdGlmICh0eXBlb2YgbGluZSAhPT0gJ3N0cmluZycpXG5cdFx0XHRcdFx0e1xuXHRcdFx0XHRcdFx0bGluZSA9IEJ1ZmZlci5mcm9tKGxpbmUpLnRvU3RyaW5nKCk7XG5cdFx0XHRcdFx0fVxuXG5cdFx0XHRcdFx0cmV0dXJuIGRvU2VnbWVudChsaW5lLCBycS5vcHRpb25zKVxuXHRcdFx0XHR9KTtcblxuXHRcdFx0XHRpZiAoIXJxLm5vY2FjaGUgJiYgIXJxLmRlYnVnKVxuXHRcdFx0XHR7XG5cdFx0XHRcdFx0cmVzLnNldCh7XG5cdFx0XHRcdFx0XHQnQ2FjaGUtQ29udHJvbCc6ICdwdWJsaWMsIG1heC1hZ2U9MzYwMDAwMCcsXG5cdFx0XHRcdFx0fSk7XG5cdFx0XHRcdH1cblxuXHRcdFx0XHRjb25zdCBqc29uID0ge1xuXHRcdFx0XHRcdGNvZGU6IDEsXG5cdFx0XHRcdFx0Y291bnQ6IHJlc3VsdHMubGVuZ3RoLFxuXHRcdFx0XHRcdHRpbWVzdGFtcCxcblx0XHRcdFx0XHR0aW1lOiBEYXRlLm5vdygpIC0gdGltZXN0YW1wLFxuXHRcdFx0XHRcdHJlc3VsdHMsXG5cdFx0XHRcdFx0b3B0aW9uczogcnEub3B0aW9ucyxcblx0XHRcdFx0fTtcblxuXHRcdFx0XHRpZiAocnEuZGVidWcpXG5cdFx0XHRcdHtcblx0XHRcdFx0XHQvLyBAdHMtaWdub3JlXG5cdFx0XHRcdFx0anNvbi5yZXF1ZXN0ID0ge1xuXHRcdFx0XHRcdFx0cnEsXG5cdFx0XHRcdFx0XHRwYXJhbXM6IHJlcS5wYXJhbXMsXG5cdFx0XHRcdFx0XHRxdWVyeTogcmVxLnF1ZXJ5LFxuXHRcdFx0XHRcdFx0Ym9keTogcmVxLmJvZHksXG5cdFx0XHRcdFx0XHRiYXNlVXJsOiByZXEuYmFzZVVybCxcblx0XHRcdFx0XHRcdHVybDogcmVxLnVybCxcblx0XHRcdFx0XHRcdHF1ZXJ5MjogdXJsX3BhcnNlKHJlcS51cmwsIHRydWUpLnF1ZXJ5LFxuXHRcdFx0XHRcdH07XG5cdFx0XHRcdH1cblxuXHRcdFx0XHRyZXMuc3RhdHVzKDIwMCkuanNvbihqc29uKTtcblxuXHRcdFx0XHRyZXR1cm47XG5cdFx0XHR9XG5cdFx0XHRjYXRjaCAoZSlcblx0XHRcdHtcblx0XHRcdFx0ZXJyb3IgPSBlO1xuXG5cdFx0XHRcdHJlcy5zdGF0dXMoNTAwKS5qc29uKHtcblx0XHRcdFx0XHRjb2RlOiAwLFxuXHRcdFx0XHRcdGVycm9yOiB0cnVlLFxuXHRcdFx0XHRcdHRpbWVzdGFtcCxcblx0XHRcdFx0XHRtZXNzYWdlOiBlcnJvci5tZXNzYWdlLFxuXHRcdFx0XHRcdHJlcXVlc3Q6IHJxLFxuXHRcdFx0XHR9KTtcblxuXHRcdFx0XHRyZXR1cm47XG5cdFx0XHR9XG5cdFx0fVxuXHR9XG5cblx0aWYgKCFycS5ub2NhY2hlKVxuXHR7XG5cdFx0cmVzLnNldCh7XG5cdFx0XHQnQ2FjaGUtQ29udHJvbCc6ICdwdWJsaWMsIG1heC1hZ2U9MTAwMDAnLFxuXHRcdH0pO1xuXHR9XG5cblx0cmVzLnN0YXR1cyg0MDApLmpzb24oe1xuXHRcdGNvZGU6IDAsXG5cdFx0ZXJyb3I6IHRydWUsXG5cdFx0dGltZXN0YW1wLFxuXHRcdG1lc3NhZ2U6ICflj4PmlbjpjK/oqqQnLFxuXHRcdHJlcXVlc3Q6IHJxLFxuXHR9KTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gYXBwX2NvbnYocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlLCBuZXh0OiBOZXh0RnVuY3Rpb24pXG57XG5cdGxldCBycSA9IGdldF9xdWVyeTx7XG5cdFx0aW5wdXQ6IHN0cmluZyB8IChzdHJpbmcgfCBCdWZmZXIpW10sXG5cdFx0b3B0aW9uczoge1xuXHRcdFx0dHcyY24/OiBib29sZWFuLFxuXHRcdH1cblx0XHRub2NhY2hlOiBib29sZWFuLFxuXHRcdGRlYnVnOiBib29sZWFuLFxuXHR9PihyZXEsIHtcblx0XHRvcHRpb25zOiB7fSxcblx0fSk7XG5cblx0Y29uc3QgdGltZXN0YW1wID0gRGF0ZS5ub3coKTtcblxuXHRsZXQgZXJyb3I6IEVycm9yO1xuXG5cdHRyeVxuXHR7XG5cdFx0Y29uc3QgeyBpbnB1dCwgZW1wdHkgfSA9IGhhbmRsZV9pbnB1dChycS5pbnB1dCk7XG5cdFx0ZGVsZXRlIHJxLmlucHV0O1xuXG5cdFx0Y29uc3QgeyB0dzJjbiB9ID0gcnEub3B0aW9ucztcblxuXHRcdGNvbnN0IHJlc3VsdHMgPSBpbnB1dF9tYXAoaW5wdXQsIChpbnB1dCkgPT5cblx0XHR7XG5cdFx0XHRsZXQgdGV4dCA9IGRvU2VnbWVudChpbnB1dCwge1xuXHRcdFx0XHRzaW1wbGU6IHRydWUsXG5cdFx0XHR9KS5qb2luKCcnKTtcblxuXHRcdFx0cmV0dXJuIHR3MmNuID8gdHcyY25fbWluKHRleHQpIDogY24ydHdfbWluKHRleHQpXG5cdFx0fSk7XG5cblx0XHRpZiAoIXJxLm5vY2FjaGUgJiYgIXJxLmRlYnVnKVxuXHRcdHtcblx0XHRcdHJlcy5zZXQoe1xuXHRcdFx0XHQnQ2FjaGUtQ29udHJvbCc6ICdwdWJsaWMsIG1heC1hZ2U9MzYwMDAwMCcsXG5cdFx0XHR9KTtcblx0XHR9XG5cblx0XHRjb25zdCBqc29uID0ge1xuXHRcdFx0Y29kZTogMSxcblx0XHRcdGNvdW50OiByZXN1bHRzLmxlbmd0aCxcblx0XHRcdHRpbWVzdGFtcCxcblx0XHRcdHRpbWU6IERhdGUubm93KCkgLSB0aW1lc3RhbXAsXG5cdFx0XHRyZXN1bHRzLFxuXHRcdH07XG5cblx0XHRyZXMuc3RhdHVzKDIwMCkuanNvbihqc29uKTtcblxuXHRcdHJldHVybjtcblx0fVxuXHRjYXRjaCAoZSlcblx0e1xuXHRcdGlmICghcnEubm9jYWNoZSlcblx0XHR7XG5cdFx0XHRyZXMuc2V0KHtcblx0XHRcdFx0J0NhY2hlLUNvbnRyb2wnOiAncHVibGljLCBtYXgtYWdlPTEwMDAwJyxcblx0XHRcdH0pO1xuXHRcdH1cblxuXHRcdHJlcy5zdGF0dXMoNTAwKS5qc29uKHtcblx0XHRcdGNvZGU6IDAsXG5cdFx0XHRlcnJvcjogdHJ1ZSxcblx0XHRcdHRpbWVzdGFtcCxcblx0XHRcdG1lc3NhZ2U6IGUubWVzc2FnZSxcblx0XHRcdHJlcXVlc3Q6IHJxLFxuXHRcdH0pO1xuXHR9XG59XG5cbmZ1bmN0aW9uIGhhbmRsZV9pbnB1dChpbnB1dDogc3RyaW5nIHwgKHN0cmluZyB8IEJ1ZmZlcilbXSlcbntcblx0aWYgKHR5cGVvZiBpbnB1dCA9PT0gJ3N0cmluZycpXG5cdHtcblx0XHRpbnB1dCA9IFtpbnB1dF07XG5cdH1cblxuXHRsZXQgZW1wdHkgPSAoaW5wdXQubGVuZ3RoID09PSAwIHx8IGlucHV0Lmxlbmd0aCA9PT0gMSAmJiBpbnB1dFswXS5sZW5ndGggPT09IDApO1xuXG5cdHJldHVybiB7XG5cdFx0aW5wdXQsXG5cdFx0ZW1wdHksXG5cdH07XG59XG5cbmZ1bmN0aW9uIGlucHV0X21hcDxUPihpbnB1dDogKHN0cmluZyB8IEJ1ZmZlcilbXSwgZm46IChpbnB1dDogc3RyaW5nKSA9PiBUKTogVFtdXG57XG5cdHJldHVybiBpbnB1dC5tYXAoaW5wdXQgPT5cblx0e1xuXG5cdFx0aWYgKHR5cGVvZiBpbnB1dCAhPT0gJ3N0cmluZycpXG5cdFx0e1xuXHRcdFx0aW5wdXQgPSBCdWZmZXIuZnJvbShpbnB1dCkudG9TdHJpbmcoKTtcblx0XHR9XG5cblx0XHRyZXR1cm4gZm4oaW5wdXQpXG5cdH0pXG59XG5cbmZ1bmN0aW9uIGNyZWF0ZVNlZ21lbnQoKVxue1xuXHRyZXR1cm4gbmV3IFNlZ21lbnQoe1xuXHRcdGF1dG9Dams6IHRydWUsXG5cdFx0b3B0aW9uc0RvU2VnbWVudDoge1xuXHRcdFx0Y29udmVydFN5bm9ueW06IHRydWUsXG5cdFx0fSxcblx0XHRhbGxfbW9kOiB0cnVlLFxuXHR9KTtcbn1cblxuZnVuY3Rpb24gZ2V0U2VnbWVudCgpXG57XG5cdGlmIChDQUNIRURfU0VHTUVOVClcblx0e1xuXHRcdHJldHVybiBDQUNIRURfU0VHTUVOVDtcblx0fVxuXG5cdGNvbnN0IERJQ1QgPSByZXF1aXJlKCcuL2NhY2hlLmpzb24nKTtcblxuXHRDQUNIRURfU0VHTUVOVCA9IGNyZWF0ZVNlZ21lbnQoKTtcblxuXHR1c2VNb2R1bGVzKENBQ0hFRF9TRUdNRU5UIGFzIGFueSwgZ2V0RGVmYXVsdE1vZExpc3QoQ0FDSEVEX1NFR01FTlQub3B0aW9ucy5hbGxfbW9kKSk7XG5cblx0Q0FDSEVEX1NFR01FTlQuRElDVCA9IERJQ1Q7XG5cdENBQ0hFRF9TRUdNRU5ULmluaXRlZCA9IHRydWU7XG5cblx0cmV0dXJuIENBQ0hFRF9TRUdNRU5UXG59XG5cbmZ1bmN0aW9uIGRvU2VnbWVudCh0ZXh0OiBzdHJpbmcsIG9wdGlvbnM/OiBJT3B0aW9uc0RvU2VnbWVudClcbntcblx0cmV0dXJuIGdldFNlZ21lbnQoKS5kb1NlZ21lbnQodGV4dCwgb3B0aW9ucylcbn1cblxuZnVuY3Rpb24gYWxsX21ldGhvZChhcHA6IEV4cHJlc3MsIHJvdXRlclBhdGg6IHN0cmluZywgLi4uY2I6IFJlcXVlc3RIYW5kbGVyUGFyYW1zW10pXG57XG5cdGFwcC5nZXQocm91dGVyUGF0aCwgLi4uY2IpO1xuXHRhcHAucG9zdChyb3V0ZXJQYXRoLCAuLi5jYik7XG5cblx0cmV0dXJuIGFwcDtcbn1cblxuZnVuY3Rpb24gZ2V0X3F1ZXJ5PFQ+KHJlcTogUmVxdWVzdCwgaW5pdDogUGFydGlhbDxUPiA9IHt9KTogVFxue1xuXHRyZXR1cm4gT2JqZWN0LmFzc2lnbihpbml0LCB1cmxfcGFyc2UocmVxLnVybCwgdHJ1ZSkucXVlcnksIHJlcS5ib2R5KTtcbn1cbiJdfQ==