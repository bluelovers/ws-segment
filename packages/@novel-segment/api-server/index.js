"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const express = require("express");
const core_1 = require("novel-segment/lib/segment/core");
const useModules2_1 = require("novel-segment/lib/segment/methods/useModules2");
const mod_1 = require("novel-segment/lib/mod");
const url_1 = require("url");
const app = express();
app.use(express.json());
app.use(express.urlencoded({ extended: true }));
let CACHED_SEGMENT;
app.get('*', fn);
app.post('*', fn);
exports.default = app;
function fn(req, res, next) {
    let rq = Object.assign({}, req.query, url_1.parse(req.url, true).query, req.body);
    res.set({
        'Access-Control-Allow-Origin': '*',
        'Content-Type': 'application/json',
    });
    const timestamp = Date.now();
    let error;
    if (rq.input && rq.input.length) {
        if (typeof rq.input === 'string') {
            rq.input = [rq.input];
        }
        if (Array.isArray(rq.input)) {
            rq.options = rq.options || {};
            try {
                const CACHED_SEGMENT = getSegment();
                const results = rq.input.map(line => {
                    if (typeof line !== 'string') {
                        line = Buffer.from(line).toString();
                    }
                    return CACHED_SEGMENT.doSegment(line);
                });
                if (!rq.nocache && !rq.debug) {
                    res.set({
                        'Cache-Control': 'public, max-age=3600000',
                    });
                }
                const json = {
                    code: 1,
                    count: results.length,
                    timestamp,
                    time: Date.now() - timestamp,
                    results,
                };
                if (rq.debug) {
                    // @ts-ignore
                    json.request = {
                        rq,
                        params: req.params,
                        query: req.query,
                        body: req.body,
                        baseUrl: req.baseUrl,
                        url: req.url,
                        query2: url_1.parse(req.url, true).query,
                    };
                }
                res.status(200).json(json);
                return;
            }
            catch (e) {
                error = e;
                res.status(500).json({
                    code: 0,
                    error: true,
                    timestamp,
                    message: error.message,
                    request: rq,
                });
                return;
            }
        }
    }
    if (!rq.nocache) {
        res.set({
            'Cache-Control': 'public, max-age=10000',
        });
    }
    res.status(400).json({
        code: 0,
        error: true,
        timestamp,
        message: '參數錯誤',
        request: rq,
    });
}
function createSegment() {
    return new core_1.default({
        autoCjk: true,
        optionsDoSegment: {
            convertSynonym: true,
        },
        all_mod: true,
    });
}
function getSegment() {
    const DICT = require('./cache.json');
    CACHED_SEGMENT = createSegment();
    useModules2_1.useModules(CACHED_SEGMENT, mod_1.default(CACHED_SEGMENT.options.all_mod));
    CACHED_SEGMENT.DICT = DICT;
    CACHED_SEGMENT.inited = true;
    return CACHED_SEGMENT;
}
exports.getSegment = getSegment;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLG1DQUFvQztBQUVwQyx5REFBNEU7QUFDNUUsK0VBQTJFO0FBQzNFLCtDQUFzRDtBQUN0RCw2QkFBeUM7QUFFekMsTUFBTSxHQUFHLEdBQUcsT0FBTyxFQUFFLENBQUM7QUFFdEIsR0FBRyxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQztBQUN4QixHQUFHLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxVQUFVLENBQUMsRUFBRSxRQUFRLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQyxDQUFDO0FBRWhELElBQUksY0FBdUIsQ0FBQztBQUU1QixHQUFHLENBQUMsR0FBRyxDQUFDLEdBQUcsRUFBRSxFQUFFLENBQUMsQ0FBQztBQUNqQixHQUFHLENBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRSxFQUFFLENBQUMsQ0FBQztBQUVsQixrQkFBZSxHQUFHLENBQUE7QUFFbEIsU0FBUyxFQUFFLENBQUUsR0FBWSxFQUFFLEdBQWEsRUFBRSxJQUFrQjtJQUUzRCxJQUFJLEVBQUUsR0FLRixNQUFNLENBQUMsTUFBTSxDQUFDLEVBQUUsRUFBRSxHQUFHLENBQUMsS0FBSyxFQUFFLFdBQVMsQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUFFLElBQUksQ0FBQyxDQUFDLEtBQUssRUFBRSxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUM7SUFFM0UsR0FBRyxDQUFDLEdBQUcsQ0FBQztRQUNQLDZCQUE2QixFQUFFLEdBQUc7UUFDbEMsY0FBYyxFQUFFLGtCQUFrQjtLQUNsQyxDQUFDLENBQUM7SUFFSCxNQUFNLFNBQVMsR0FBRyxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUM7SUFFN0IsSUFBSSxLQUFZLENBQUM7SUFFakIsSUFBSSxFQUFFLENBQUMsS0FBSyxJQUFJLEVBQUUsQ0FBQyxLQUFLLENBQUMsTUFBTSxFQUMvQjtRQUND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QUFjLEVBQUUsSUFBSTtTQUNwQjtRQUNELE9BQU8sRUFBRSxJQUFJO0tBQ2IsQ0FBQyxDQUFDO0FBQ0osQ0FBQztBQUVELFNBQWdCLFVBQVU7SUFFekIsTUFBTSxJQUFJLEdBQUcsT0FBTyxDQUFDLGNBQWMsQ0FBQyxDQUFDO0lBRXJDLGNBQWMsR0FBRyxhQUFhLEVBQUUsQ0FBQztJQUVqQyx3QkFBVSxDQUFDLGNBQXFCLEVBQUUsYUFBaUIsQ0FBQyxjQUFjLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUM7SUFFckYsY0FBYyxDQUFDLElBQUksR0FBRyxJQUFJLENBQUM7SUFDM0IsY0FBYyxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUM7SUFFN0IsT0FBTyxjQUFjLENBQUE7QUFDdEIsQ0FBQztBQVpELGdDQVlDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGV4cHJlc3MgPSByZXF1aXJlKCdleHByZXNzJyk7XG5pbXBvcnQgeyBOZXh0RnVuY3Rpb24sIFJlcXVlc3QsIFJlc3BvbnNlIH0gZnJvbSAnZXhwcmVzcy1zZXJ2ZS1zdGF0aWMtY29yZSc7XG5pbXBvcnQgU2VnbWVudCwgeyBJT3B0aW9uc0RvU2VnbWVudCB9IGZyb20gJ25vdmVsLXNlZ21lbnQvbGliL3NlZ21lbnQvY29yZSc7XG5pbXBvcnQgeyB1c2VNb2R1bGVzIH0gZnJvbSAnbm92ZWwtc2VnbWVudC9saWIvc2VnbWVudC9tZXRob2RzL3VzZU1vZHVsZXMyJztcbmltcG9ydCBnZXREZWZhdWx0TW9kTGlzdCBmcm9tICdub3ZlbC1zZWdtZW50L2xpYi9tb2QnO1xuaW1wb3J0IHsgcGFyc2UgYXMgdXJsX3BhcnNlIH0gZnJvbSAndXJsJztcblxuY29uc3QgYXBwID0gZXhwcmVzcygpO1xuXG5hcHAudXNlKGV4cHJlc3MuanNvbigpKTtcbmFwcC51c2UoZXhwcmVzcy51cmxlbmNvZGVkKHsgZXh0ZW5kZWQ6IHRydWUgfSkpO1xuXG5sZXQgQ0FDSEVEX1NFR01FTlQ6IFNlZ21lbnQ7XG5cbmFwcC5nZXQoJyonLCBmbik7XG5hcHAucG9zdCgnKicsIGZuKTtcblxuZXhwb3J0IGRlZmF1bHQgYXBwXG5cbmZ1bmN0aW9uIGZuIChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UsIG5leHQ6IE5leHRGdW5jdGlvbilcbntcblx0bGV0IHJxOiB7XG5cdFx0aW5wdXQ6IHN0cmluZyB8IChzdHJpbmcgfCBCdWZmZXIpW10sXG5cdFx0b3B0aW9uczogSU9wdGlvbnNEb1NlZ21lbnQsXG5cdFx0bm9jYWNoZTogYm9vbGVhbixcblx0XHRkZWJ1ZzogYm9vbGVhbixcblx0fSA9IE9iamVjdC5hc3NpZ24oe30sIHJlcS5xdWVyeSwgdXJsX3BhcnNlKHJlcS51cmwsIHRydWUpLnF1ZXJ5LCByZXEuYm9keSk7XG5cblx0cmVzLnNldCh7XG5cdFx0J0FjY2Vzcy1Db250cm9sLUFsbG93LU9yaWdpbic6ICcqJyxcblx0XHQnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nLFxuXHR9KTtcblxuXHRjb25zdCB0aW1lc3RhbXAgPSBEYXRlLm5vdygpO1xuXG5cdGxldCBlcnJvcjogRXJyb3I7XG5cblx0aWYgKHJxLmlucHV0ICYmIHJxLmlucHV0Lmxlbmd0aClcblx0e1xuXHRcdGlmICh0eXBlb2YgcnEuaW5wdXQgPT09ICdzdHJpbmcnKVxuXHRcdHtcblx0XHRcdHJxLmlucHV0ID0gW3JxLmlucHV0XTtcblx0XHR9XG5cblx0XHRpZiAoQXJyYXkuaXNBcnJheShycS5pbnB1dCkpXG5cdFx0e1xuXHRcdFx0cnEub3B0aW9ucyA9IHJxLm9wdGlvbnMgfHwge307XG5cblx0XHRcdHRyeVxuXHRcdFx0e1xuXHRcdFx0XHRjb25zdCBDQUNIRURfU0VHTUVOVCA9IGdldFNlZ21lbnQoKTtcblxuXHRcdFx0XHRjb25zdCByZXN1bHRzID0gcnEuaW5wdXQubWFwKGxpbmUgPT4ge1xuXG5cdFx0XHRcdFx0aWYgKHR5cGVvZiBsaW5lICE9PSAnc3RyaW5nJylcblx0XHRcdFx0XHR7XG5cdFx0XHRcdFx0XHRsaW5lID0gQnVmZmVyLmZyb20obGluZSkudG9TdHJpbmcoKTtcblx0XHRcdFx0XHR9XG5cblx0XHRcdFx0XHRyZXR1cm4gQ0FDSEVEX1NFR01FTlQuZG9TZWdtZW50KGxpbmUpXG5cdFx0XHRcdH0pO1xuXG5cdFx0XHRcdGlmICghcnEubm9jYWNoZSAmJiAhcnEuZGVidWcpXG5cdFx0XHRcdHtcblx0XHRcdFx0XHRyZXMuc2V0KHtcblx0XHRcdFx0XHRcdCdDYWNoZS1Db250cm9sJzogJ3B1YmxpYywgbWF4LWFnZT0zNjAwMDAwJyxcblx0XHRcdFx0XHR9KTtcblx0XHRcdFx0fVxuXG5cdFx0XHRcdGNvbnN0IGpzb24gPSB7XG5cdFx0XHRcdFx0Y29kZTogMSxcblx0XHRcdFx0XHRjb3VudDogcmVzdWx0cy5sZW5ndGgsXG5cdFx0XHRcdFx0dGltZXN0YW1wLFxuXHRcdFx0XHRcdHRpbWU6IERhdGUubm93KCkgLSB0aW1lc3RhbXAsXG5cdFx0XHRcdFx0cmVzdWx0cyxcblx0XHRcdFx0fTtcblxuXHRcdFx0XHRpZiAocnEuZGVidWcpXG5cdFx0XHRcdHtcblx0XHRcdFx0XHQvLyBAdHMtaWdub3JlXG5cdFx0XHRcdFx0anNvbi5yZXF1ZXN0ID0ge1xuXHRcdFx0XHRcdFx0cnEsXG5cdFx0XHRcdFx0XHRwYXJhbXM6IHJlcS5wYXJhbXMsXG5cdFx0XHRcdFx0XHRxdWVyeTogcmVxLnF1ZXJ5LFxuXHRcdFx0XHRcdFx0Ym9keTogcmVxLmJvZHksXG5cdFx0XHRcdFx0XHRiYXNlVXJsOiByZXEuYmFzZVVybCxcblx0XHRcdFx0XHRcdHVybDogcmVxLnVybCxcblx0XHRcdFx0XHRcdHF1ZXJ5MjogdXJsX3BhcnNlKHJlcS51cmwsIHRydWUpLnF1ZXJ5LFxuXHRcdFx0XHRcdH07XG5cdFx0XHRcdH1cblxuXHRcdFx0XHRyZXMuc3RhdHVzKDIwMCkuanNvbihqc29uKTtcblxuXHRcdFx0XHRyZXR1cm47XG5cdFx0XHR9XG5cdFx0XHRjYXRjaCAoZSlcblx0XHRcdHtcblx0XHRcdFx0ZXJyb3IgPSBlO1xuXG5cdFx0XHRcdHJlcy5zdGF0dXMoNTAwKS5qc29uKHtcblx0XHRcdFx0XHRjb2RlOiAwLFxuXHRcdFx0XHRcdGVycm9yOiB0cnVlLFxuXHRcdFx0XHRcdHRpbWVzdGFtcCxcblx0XHRcdFx0XHRtZXNzYWdlOiBlcnJvci5tZXNzYWdlLFxuXHRcdFx0XHRcdHJlcXVlc3Q6IHJxLFxuXHRcdFx0XHR9KTtcblxuXHRcdFx0XHRyZXR1cm47XG5cdFx0XHR9XG5cdFx0fVxuXHR9XG5cblx0aWYgKCFycS5ub2NhY2hlKVxuXHR7XG5cdFx0cmVzLnNldCh7XG5cdFx0XHQnQ2FjaGUtQ29udHJvbCc6ICdwdWJsaWMsIG1heC1hZ2U9MTAwMDAnLFxuXHRcdH0pO1xuXHR9XG5cblx0cmVzLnN0YXR1cyg0MDApLmpzb24oe1xuXHRcdGNvZGU6IDAsXG5cdFx0ZXJyb3I6IHRydWUsXG5cdFx0dGltZXN0YW1wLFxuXHRcdG1lc3NhZ2U6ICflj4PmlbjpjK/oqqQnLFxuXHRcdHJlcXVlc3Q6IHJxLFxuXHR9KTtcbn1cblxuZnVuY3Rpb24gY3JlYXRlU2VnbWVudCgpXG57XG5cdHJldHVybiBuZXcgU2VnbWVudCh7XG5cdFx0YXV0b0NqazogdHJ1ZSxcblx0XHRvcHRpb25zRG9TZWdtZW50OiB7XG5cdFx0XHRjb252ZXJ0U3lub255bTogdHJ1ZSxcblx0XHR9LFxuXHRcdGFsbF9tb2Q6IHRydWUsXG5cdH0pO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0U2VnbWVudCgpXG57XG5cdGNvbnN0IERJQ1QgPSByZXF1aXJlKCcuL2NhY2hlLmpzb24nKTtcblxuXHRDQUNIRURfU0VHTUVOVCA9IGNyZWF0ZVNlZ21lbnQoKTtcblxuXHR1c2VNb2R1bGVzKENBQ0hFRF9TRUdNRU5UIGFzIGFueSwgZ2V0RGVmYXVsdE1vZExpc3QoQ0FDSEVEX1NFR01FTlQub3B0aW9ucy5hbGxfbW9kKSk7XG5cblx0Q0FDSEVEX1NFR01FTlQuRElDVCA9IERJQ1Q7XG5cdENBQ0hFRF9TRUdNRU5ULmluaXRlZCA9IHRydWU7XG5cblx0cmV0dXJuIENBQ0hFRF9TRUdNRU5UXG59XG4iXX0=